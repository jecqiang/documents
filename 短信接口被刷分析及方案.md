## 短信接口被刷分析 ##

### **同一IP发送请求排名：** ###

![](http://i.imgur.com/HRGW2eK.png)

### **同一IP请求部分数据（敏感数据省略）：** ###

### **分析结论：** ###

- 恶意请求短信接口的全部是国外的IP（通过代理）
- 通过发送**注册验证码**的类型，其他类型会先判断数据库是否存在该手机号码
- 发送验证码后从不验证
- 发送频繁，平均每分钟发送十几条

### **防护方案：** ###

1. 增加图形验证码
2. 单IP请求次数限制
3. 限制号码发送时长和发送量
4. 接口请求加密和鉴权

### **各方案实施说明：** ###

（一）增加图形验证码

  恶意攻击者采用自动化工具，自动对短信接口进行大量调用，采用图片验证码可有效防止工具自动化调用，即当用户进行“获取动态短信” 操作前，弹出图片验证码，要求用户输入正确的验证码后，服务器端再发送动态短信到用户手机上，该方法可有效解决短信轰炸问题。但是会影响用户体验。建议服务器端根据实际情况动态弹出图片验证码，比如检查到是外国IP或多次请求即弹出图片验证码

（二）单IP请求次数限制

服务器端限制单个IP在单位时间内的请求次数，一旦用户请求次数(包括失败请求次数)超出设定的阈值，则暂停对该 IP 一段时间的请求;若情节特别严重，可以将 IP 加入黑名单，禁止该 IP 的访问请 求。该措施能限制一个 IP 地址的大量请求，避免攻击者通过同一个 IP 大量调用短信接口，增加了攻击难度。

**特例：**某线下商场做活动，出现同一IP大量请求短信接口，就会出现误伤。

**解决方案：**
 
1. 结合具体业务做IP限制，比如只统计获取了验证码但是从不进行验证的IP
2. 把IP加入白名单，客服接到业务员的电话告知做活动，把IP加入白名单

（三）限制号码发送时长和发送量

单个用户请求发送一次动态短信之后，服务器端限制只有在一定时长之后（60秒），才能进行第二次动态短信请求，且半小内不可超过多少次（6次）

（四）接口请求加密和鉴权

接口加密和增加鉴权可以有效防止模拟请求

### **请求短信发送流程：** ###

![](http://i.imgur.com/bIdRsuj.png)

**流程说明：**

1、输入手机号码请求接口发送短信

2、服务器器接受请求

3、对接口鉴权，鉴权不通过直接返回失败

4、验证输入的手机号码，所有不成功都返回失败

- 验证手机号格式是否合法，验证发送类型是否正确
- 除注册接口外，验证手机号是否在数据库存在。
- 同一号码，60秒内只能发送一次，半小时内只能发送6条，一天内只能发送30条

5、验证IP

- 该IP在白名单中（比如深圳研发中心的IP），不做限制直接入库发送短信
- 该IP在黑名单中，直接返回失败
- 该IP是否第一次请求，是就不做限制直接入库发送短信
- 该IP是第二次或以上请求，而且是国外IP，服务器生成图形验证码的地址，返回给客户端要求输入图形验证码
- **结合业务做IP限制，统计获取了验证码但是从不进行验证的IP，达到3次要求输入图形验证码，20次把IP加入黑名单**

6、入库，短信服务器发送短信到用户的手机

7、用户接受短信验证码后进行验证